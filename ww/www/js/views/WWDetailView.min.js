define(["text!templates/ww/ww-detail-tpl.html"],function(e){var t=function(){this.initialize=function(){this.$el=$("<div/>");this.$el.html($wwCompile(e)(getScope()));this.hash=window.location.hash.substr(1)};this.clearData=function(){this.$el.find("#ww-detail-content").hide();setScope("currentWW",{})};this._initToggle=function(){var e=this;e.$el.find("#ww-detail-content").show();if(parseInt(e.$el.find(".ww-item-content").css("height"))<parseInt(e.$el.find(".ww-item-content").css("max-height"))){e.$el.find(".ww-content-toggle").removeClass("visible")}else{e.$el.find(".ww-content-toggle").addClass("visible")}};var t=15;this._articleSortBy="createTime";this.loadArticles=function(e){var i=this;window.articleService.getArticles(getScope("currentWW")._id,{countPerPage:t,lastId:e?null:i.$el.find(".article-list ul li:last").attr("data-id"),sortBy:i._articleSortBy,lastIds:function(e){if(i._articleSortBy=="agree"){var t=[];var n=$(e[e.length-1]);for(var o=0;o<e.length;o++){if($(e.get(e.length-1-o)).attr("data-agree")==n.attr("data-agree")){t.push($(e.get(e.length-1-o)).attr("data-id"))}else{break}}return t}else{return undefined}}(i.$el.find(".article-list ul li"))}).done(function(n){if(!n||n.length==0){i._scrollLoader.endOfScroll()}else{if(e){setScope("currentWW",$.extend(getScope("currentWW"),{wwArticles:n}));i._initScrollLoader()}else{setScope("currentWW",$.extend(getScope("currentWW"),{wwArticles:getScope("currentWW").wwArticles.concat(n)}))}if(n.length<t){i._scrollLoader.endOfScroll()}else{i._scrollLoader.removeLoader()}}})};this._initScrollLoader=function(){var e=this;e._scrollLoader=e.$el.find("#ww-detail-content").wwScrollLoader({loadBottom:function(t){e.loadArticles()},pull:function(e){},pullEnd:function(){},onScroll:function(t){if(t<e.$el.find(".title-block h4").height()){setScope("currentWW",$.extend(getScope("currentWW"),{_showTitle:false}))}else{setScope("currentWW",$.extend(getScope("currentWW"),{_showTitle:true}))}}})};this.render=function(e){var i=this;i.$el.wwViewLoader();i.$el.find(".content-block").removeClass("autoHeightContent");i.$el.find(".ww-content-toggle").removeClass("icon-up").addClass("icon-down");window.wwService.findById(e,{articleCountPerPage:t}).done(function(e){i.$el.wwViewLoader("R");e.detail=$wwSce.trustAsHtml(e.detail);e.isCreator=window.user&&window.user.userId===(e.author?e.author.userId:-1);setScope("currentWW",e);i.$el.find(".ww-item-content img").each(function(){$(this).load(function(){i._initToggle()}).attr("src",context_root+$(this).attr("data-src"))});e._detail=i.$el.find(".ww-item-content").html();i._initToggle();i._initScrollLoader()});return i};this.bindEvents=function(){var e=this;e.$el.off("click.lefNav").on("click.lefNav",".icon-left-nav",function(){window.backHandler()});e.$el.off("click.toggle").on("click.toggle",".ww-content-toggle",function(){if($(this).hasClass("icon-down")){$(this).closest(".content-block").addClass("autoHeightContent");$(this).removeClass("icon-down").addClass("icon-up")}else{$(this).closest(".content-block").removeClass("autoHeightContent");$(this).removeClass("icon-up").addClass("icon-down")}});e.$el.off("click.comments").on("click.comments",".footer .comments",function(){window.location.href="#ww/detail/"+getScope("currentWW")._id+"/comments"});var t=function(e,t,i){var n=e+"d";if(e=="watch"||e=="collect"){n=e+"ed"}if(t&&t[e]!=undefined){var o={};o[e]=t[e];o[n]=t[n];setScope("currentWW",$.extend(getScope("currentWW"),o));alert(i)}};e.$el.off("click.btn-agree").on("click.btn-agree",".btn-agree",function(){var e=getScope("currentWW");if(e.agreed){window.wwService.agreeOn(e._id,-1).done(function(e){t("agree",e,"已取消点赞")})}else{window.wwService.agreeOn(e._id,1).done(function(e){t("agree",e,"已点赞")})}});e.$el.off("click.btn-watch").on("click.btn-watch",".btn-watch",function(){var e=getScope("currentWW");if(e.watched){window.wwService.watchOn(e._id,-1).done(function(e){t("watch",e,"已取消关注")})}else{window.wwService.watchOn(e._id,1).done(function(e){t("watch",e,"已关注")})}});e.$el.off("click.collect").on("click.collect",".collect",function(){var e=getScope("currentWW");if(e.collected){window.wwService.collectOn(e._id,-1).done(function(e){t("collect",e,"已取消收藏")})}else{window.wwService.collectOn(e._id,1).done(function(e){t("collect",e,"已收藏")})}});e.$el.off("click.article").on("click.article",".article-list li",function(){window.location.href="#ww/detail/"+getScope("currentWW")._id+"/article/detail/"+$(this).attr("data-id")});e.$el.off("click.compose-article").on("click.compose-article",".compose-article",function(){window.location.href="#ww/detail/"+getScope("currentWW")._id+"/article/create"});e.$el.off("click.actions").on("click.actions",".bar-tab span.edit-ww",function(){window.location.href="#ww/edit"});var i=e.$el.find(".article-list").wwPopupMenu({hideList:function(){},items:[{icon:"icon-sort-asc",text:"时间升序",selected:true,sortBy:"createTime",onClick:function(t){e._articleSortBy=t.sortBy;e.loadArticles(true)}},{icon:"icon-sort-desc",text:"时间降序",sortBy:"-createTime",onClick:function(t){e._articleSortBy=t.sortBy;e.loadArticles(true)}},{icon:"icon-thumb-up",text:"点赞最多",sortBy:"agree",onClick:function(t){e._articleSortBy=t.sortBy;e.loadArticles(true)}}]});e.$el.off("click.articleSortingIcon").on("click.articleSortingIcon",".article-block .header .icon",function(){i.toggleList()});$(window).off("wwbeforechangeview.wwDetail").on("wwbeforechangeview.wwDetail",function(t,i,n){if(i==e.hash){e._scrollLoader.rememberScroll()}else if(n==e.hash){e._scrollLoader.resetScroll()}});return e};this.initialize()};return t});