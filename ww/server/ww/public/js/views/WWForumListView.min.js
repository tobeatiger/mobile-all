define(["text!templates/ww/ww-forum-tpl.html"],function(e){var t=function(t){this.initialize=function(){this.$el=$('<div class="ww-scroll-loader-inner-wrap"/>');this.$el.html($wwCompile(e)(getScope()));this.hash=window.location.hash.substr(1)};this.countPerPage=14;this._done=function(e,i,o){if(!e){return}var n=this;n.firstItemUpdateTime=e.length?e[0].updateTime:n.firstItemUpdateTime;if(i){setScope("wwItems",e.concat(_.differenceBy(getScope("wwItems"),e,"_id")));n._scrollLoader.resetLoaderPosition()}else if(o){setScope("wwItems",e,false)}else{n.lastItemUpdateTime=e.length?e[e.length-1].updateTime:n.lastItemUpdateTime;setScope("wwItems",e,true)}t.wwViewLoader("H");if(!getScope("wwItems")||getScope("wwItems").length==0){n.$el.find(".no-wws").show()}else{n.$el.find(".no-wws").hide()}};this.render=function(){var e=this;t.append(e.$el);e.$ul=e.$el.find("ul");var i=$.wwFloatingButton({target:t,btnName:"ww-forum-floating-btn",icon:"icon-more",onClick:function(){o.toggleList();if(i.hasClass("icon-more")){i.switchIcon("icon-cross")}else{i.switchIcon()}}});var o=i.wwFloatingList({hideList:function(){i.switchIcon()},items:[{icon:"icon-search",text:"搜索",onClick:function(e){o.toggleList();i.switchIcon();window.location.href="#ww/search"}},{icon:"icon-filter",text:"选择标签",onClick:function(e){alert("TODO")}},{icon:"icon-plus",text:"创建为谏",onClick:function(e){o.toggleList();i.switchIcon();window.location.href="#ww/create"}}]});t.wwViewLoader(null,{top:100});e.retrieveWW().done(function(t){e._done(t)});return e};this.retrieveWW=function(){var e=this;e.$el.find(".no-wws").hide();return window.wwService.getWWs(this.countPerPage,e.lastItemUpdateTime)};this.retrieveNewWW=function(){var e=this;e.$el.find(".no-wws").hide();t.wwViewLoader(null,{top:100});return window.wwService.getNewWWs(e.firstItemUpdateTime)};this.bindEvents=function(){var e=this;e._scrollLoader=t.wwScrollLoader({loadBottom:function(t){var i=this;e.retrieveWW().done(function(t){e._done(t);if(t.length<e.countPerPage){i.endOfScroll()}else{i.removeLoader()}})},pull:function(i){if(!e._loadingNewWW){if(i-80<30){t.wwViewLoader(null,{top:i-80}).addClass("noAnimation").css("transform","rotate("+i*2+"deg)")}else{e._loadingNewWW=true;t.wwViewLoader().removeClass("noAnimation");e.retrieveNewWW().done(function(t){e._done(t,true);alert(t.length+" 条新为谏",{top:200},2e3);setTimeout(function(){e._loadingNewWW=false},2e3)})}}},pullEnd:function(){if(!e._loadingNewWW){t.wwViewLoader().removeClass("noAnimation");t.wwViewLoader("H")}}});$(window).off("wwbeforechangeview").on("wwbeforechangeview",function(t,i,o){if(i==e.hash){e._scrollLoader.rememberScroll()}else if(o==e.hash){e._scrollLoader.resetScroll()}});$(e.$el).off("click.li").on("click.li","li.table-view-cell",function(){window.location.href="#ww/detail/"+$(this).attr("data-id")});$(e.$el).off("click.reload-ww").on("click.reload-ww",".no-wws .reload-ww",function(){t.wwViewLoader();e.retrieveWW().done(function(t){e._done(t)})});return e};this.initialize()};return t});