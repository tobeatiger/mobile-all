define(["text!templates/comments-tpl.html"],function(e){var t=function(t,n,i){this.initialize=function(){this.$el=$("<div/>");this.$el.html($wwCompile(e)(getScope()));setScope("commentList",[]);setScope("commentInputChange",this._inputChange.bind(this))};this._inputChange=function(){var e=this.$el.find(".comment-input textarea");if(e.prop("scrollHeight")>35){e.css("padding-top","5px")}else{e.css("padding-top","10px")}};function o(e){if(e){_.forEach(e.comments,function(t){if(_.find(e.user.commentAgrees,{_id:t._id})){t.agreed=true}});var t=_.filter(e.comments,function(e){return e.replyTo});e.comments=_.filter(e.comments,function(e){return!e.replyTo});var n;_.forEach(t,function(t){n=_.find(e.comments,{_id:t.replyTo});if(n){if(!n.subComments){n.subComments=[]}n.subComments.push(t)}})}return e}var r=15;this.render=function(e){var c=this;c._currentSortBy=e||"createTime";c.$el.wwViewLoader();var a;if(i=="ww"){a=window.wwService.getComments(t,{countPerPage:r,sortBy:c._currentSortBy},true)}else{a=window.articleService.getComments(n,{countPerPage:r,sortBy:c._currentSortBy},true)}a.done(function(e){if(e){e=o(e);setScope("commentList",[]);setScope("commentList",e.comments);c._initScrollLoader()}c.$el.find(".no-items").removeClass("hidden");c.$el.wwViewLoader("R")});return c};this._initScrollLoader=function(){var e=this;e._scrollLoader=e.$el.find(".container").wwScrollLoader({insertAfter:function(){return e.$el.find(".ww-scroll-loader-inner-wrap > ul > li:last")},loadBottom:function(c){var a=this;var s;var l=e.$el.find(".ww-scroll-loader-inner-wrap > ul > li:last").attr("data-id");var m=function(t){if(e._currentSortBy=="agree"){var n=[];var i=$(t[t.length-1]);for(var o=0;o<t.length;o++){if($(t.get(t.length-1-o)).attr("data-agree")==i.attr("data-agree")){n.push($(t.get(t.length-1-o)).attr("data-id"))}else{break}}return n}else{return undefined}}(e.$el.find(".ww-scroll-loader-inner-wrap > ul > li"));var d={countPerPage:r,sortBy:e._currentSortBy,lastId:l,lastIds:m};if(i=="ww"){s=window.wwService.getComments(t,d)}else{s=window.articleService.getComments(n,d)}s.done(function(e){if(e&&e.comments&&e.comments.length){e=o(e);setScope("commentList",e.comments,true);a.removeLoader()}else{a.endOfScroll()}})},pull:function(e){},pullEnd:function(){}})};this.bindEvents=function(){var e=this;e.$el.off("click.lefNav").on("click.lefNav",".icon-left-nav",function(){window.backHandler()});e.$el.off("click.addComment").on("click.addComment",".addComment",function(){var o,r;if(i=="ww"){o=window.wwService;r=t}else{o=window.articleService;r=n}o.addComment(r,getScope("wwAddComment"),e.$el.find(".comment-input textarea").attr("data-reply-to")).done(function(t){if(!t.replyTo){e.render(e._floatingMenu$.getSelectedItem().sortBy)}else{var n=getScope("commentList");var i=_.find(n,{_id:t.replyTo});if(!i.subComments){i.subComments=[]}i.subComments.push(t);setScope("commentList",n)}e.$el.trigger("click.resetComment")})});e.$el.off("click.sub-comment-toggle").on("click.sub-comment-toggle",".sub-comment-toggle, .toggle-area",function(e){e.stopPropagation();var t=$(this);if(t.hasClass("toggle-area")){t=t.find(".sub-comment-toggle")}var n=t.closest(".comment-item").find(".comment-sub-list").toggleClass("hidden");if(n.hasClass("hidden")){t.text("展开")}else{t.text("收起")}});e.$el.off("click.agree").on("click.agree",".icon.agree",function(e){e.stopPropagation();var t=$(this);var n;if(t.hasClass("active")){if(i=="ww"){n=window.wwService.commentAgree(t.closest(".comment-item").attr("data-id"),-1)}else{n=window.articleService.commentAgree(t.closest(".comment-item").attr("data-id"),-1)}}else{if(i=="ww"){n=window.wwService.commentAgree(t.closest(".comment-item").attr("data-id"),1)}else{n=window.articleService.commentAgree(t.closest(".comment-item").attr("data-id"),1)}}n.done(function(e){if(e.agreed){t.addClass("active");t.find("span").text(e.agree)}else{t.removeClass("active");t.find("span").text(e.agree)}})});e.$el.off("click.li").on("click.li",".comment-list .comment-item",function(t){t.stopPropagation();var n="";var i=$(this).attr("data-id");if($(this).hasClass("comment-sub-item")){n="回复 "+$(this).find(".userName").eq(0).text()+": ";i=$(this).parent().closest(".comment-item").attr("data-id")}e.$el.find(".comment-input textarea").attr("placeholder","回复 "+$(this).find(".userName").eq(0).text()).attr("data-reply-to",i).val(n).focus()});e.$el.off("click.resetComment").on("click.resetComment",function(t){if(!$(t.target).hasClass("addComment")&&!$(t.target).parent().hasClass("comment-input")){e.$el.find(".comment-input textarea").attr("placeholder","写评论").val("").removeAttr("data-reply-to");setScope("wwAddComment","")}});e._floatingMenu$=e.$el.find(".container").wwPopupMenu({hideList:function(){},items:[{icon:"icon-sort-asc",text:"时间升序",selected:true,sortBy:"createTime",onClick:function(t){e.render(t.sortBy)}},{icon:"icon-sort-desc",text:"时间降序",sortBy:"-createTime",onClick:function(t){e.render(t.sortBy)}},{icon:"icon-thumb-up",text:"点赞最多",sortBy:"agree",onClick:function(t){e.render(t.sortBy)}}]});e.$el.off("click.icon-pull-right").on("click.icon-pull-right","header .icon.pull-right",function(){e._floatingMenu$.toggleList()});return e};this.initialize()};return t});